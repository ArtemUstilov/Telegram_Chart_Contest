<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Page Title</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="/dist/bundle.js"></script>
    <link rel="stylesheet" type="text/css" href="canvas.css">
</head>
<body>
<canvas id="canvas" width="500" height="500"></canvas>
<div class="preview-wrap">
    <canvas id="preview" width="500" height="50"></canvas>
    <div id="marker" class="marker"></div>
</div>
<script>
  let data;
  fetch('/data/chart_data.json')
    .then(res => res.json())
    .then(res => {
      data = format(res[0]);
      run(data);
    })
    .catch(err => console.log(err));

  function format(data) {
    return ({
      lines: data.columns.filter(col => data.types[col[0]] === 'line').map(line => ({
        values: line.slice(1),
        color: data.colors[line[0]],
        name: data.names[line[0]],
      })),
      x: data.columns.find(col => data.types[col[0]] === 'x').slice(1),
    })
  }

  function run(data) {
    let element = document.getElementById('canvas');
    const canvasGraph = graph.createCanvasGraph(element);
    const minX = Math.min(...data.x);
    const maxX = Math.max(...data.x);
    const minY = Math.min(...data.lines[0].values, ...data.lines[1].values);
    const maxY = Math.max(...data.lines[0].values, ...data.lines[1].values);
    const scale = { minX, maxX, minY, maxY };
    //const scale2 = { minX: 3, maxX: 6, minY: 1, maxY: 6 };
    canvasGraph.setData(data);
    canvasGraph.setScale(scale);
    canvasGraph.refresh();
    let el = document.getElementById('marker');
    dragMaster.makeDraggable(el, 0, 500, 10);
  }


  const dragMaster = (function () {
    let dragObject;
    let mouseOffset;
    let leftEdge;
    let rightEdge;
    let mWidth;
    let offsetWidth;
    let clientWidth;
    let dragObjWidth;

    function getMouseOffset(target, e) {
      const docPos = { x: target.offsetLeft, y: target.offsetTop };
      return { x: e.pageX - docPos.x, y: e.pageY - docPos.y }
    }

    function mouseUp() {
      dragObject = null;
      document.onmousemove = null;
      document.onmouseup = null;
      document.ondragstart = null;
      document.body.onselectstart = null
    }

    function stretchRight(e) {
      let width = e.pageX - dragObject.offsetLeft;
      if (dragObject.offsetLeft + width > clientWidth) {
        width = clientWidth - dragObject.offsetLeft;
      }
      width = width < 0 ? 0 : width;
      dragObject.style.width = width + 'px';
    }

    function stretchLeft(e) {
      if (dragObject.offsetLeft + dragObject.clientWidth - e.pageX <= leftEdge) {
        dragObject.style.left = dragObject.offsetLeft + dragObject.offsetWidth - mWidth * 2 + 'px'
        dragObject.style.width = 0;
      } else {
        let left = e.pageX > dragObject.offsetLeft + dragObject.offsetWidth ? clientWidth : e.pageX;
        const width = dragObject.offsetLeft + dragObject.clientWidth - left;
        dragObject.style.width = width + 'px';
        dragObject.style.left = left + 'px';
      }
    }

    function mouseMove(e) {
      let d = e.pageX - mouseOffset.x;
      let r = rightEdge - dragObject.offsetWidth;
      d = d < leftEdge ? leftEdge : d > r ? r : d;
      dragObject.style.left = d + 'px';
    }

    function mouseDown(e) {
      if (e.which !== 1) return;
      dragObject = this;
      mouseOffset = getMouseOffset(this, e);
      dragObjWidth = dragObject.clientWidth;
      const x = e.offsetX;
      if (x > dragObject.clientWidth)
        document.onmousemove = stretchRight;
      else if (x < 0)
        document.onmousemove = stretchLeft;
      else
        document.onmousemove = mouseMove;
      document.onmouseup = mouseUp;
      document.ondragstart = function () {
      };
      document.body.onselectstart = function () {
      };
    }

    return {
      makeDraggable: function (element, left, right, markersWidth) {
        element.onmousedown = mouseDown;
        leftEdge = left;
        rightEdge = right;
        mWidth = markersWidth;
        offsetWidth = right - left;
        clientWidth = offsetWidth - mWidth * 2;
      }
    }
  })();
</script>
</body>
</html>
